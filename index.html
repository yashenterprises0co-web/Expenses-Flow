<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expenses Flow | Financial Management Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --primary-light: #eef2ff;
            --secondary: #6c757d;
            --success: #28a745;
            --success-light: #e6ffed;
            --danger: #dc3545;
            --danger-light: #ffebee;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border: #dee2e6;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --sidebar-width: 260px;
            --header-height: 70px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* [Previous CSS remains exactly the same until new additions] */

        /* NEW STYLES */
        .financial-year-display {
            background: var(--primary-light);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            margin-right: 15px;
        }
        .company-selector {
            margin-right: 15px;
            min-width: 150px;
        }
        .prefix-preview {
            font-family: monospace;
            background: var(--light-gray);
            padding: 8px;
            border-radius: 4px;
            margin-top: 5px;
            border: 1px solid var(--border);
        }
        .token-badge {
            display: inline-block;
            padding: 2px 5px;
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 0.8rem;
            margin: 2px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Login View -->
    <div id="login-view" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <h1>Expenses Flow</h1>
                <p>Professional Financial Document Management</p>
            </div>
            <div class="login-options">
                <button id="google-signin-btn" class="google-signin">
                    <i class="fab fa-google"></i> Sign in with Google
                </button>
            </div>
            <div class="divider"></div>
            <p class="text-muted">Enterprise-Grade Financial Management</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Expenses Flow</h2>
            </div>
            <div class="sidebar-menu">
                <a class="menu-item active" data-view="dashboard">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a class="menu-item" data-view="create-invoice">
                    <i class="fas fa-file-invoice"></i> Create Invoice
                </a>
                <a class="menu-item" data-view="create-quotation">
                    <i class="fas fa-file-contract"></i> Create Quotation
                </a>
                <a class="menu-item" data-view="create-challan">
                    <i class="fas fa-truck-loading"></i> Create Challan
                </a>
                <a class="menu-item" data-view="view-documents">
                    <i class="fas fa-folder-open"></i> View Documents
                </a>
                <a class="menu-item" data-view="admin-panel">
                    <i class="fas fa-user-cog"></i> Admin Panel
                </a>
                <a class="menu-item" data-view="settings">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <button class="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">Dashboard</h1>
                </div>
                <div class="header-right">
                    <select id="company-selector" class="company-selector form-control">
                        <option value="main">Main Company</option>
                    </select>
                    <div id="financial-year-display" class="financial-year-display">
                        FY: 2023-24
                    </div>
                    <button class="action-btn" id="new-document-btn">
                        <i class="fas fa-plus"></i> New Document
                    </button>
                    <div class="user-profile" id="user-profile">
                        <img id="user-avatar" src="https://randomuser.me/api/portraits/men/32.jpg" alt="User" class="user-avatar">
                        <span class="user-name" id="user-name">John Smith</span>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content">
                <!-- [All previous view content remains the same] -->
                
                <!-- Enhanced Settings View -->
                <div id="settings-view" class="view-content hidden">
                    <!-- [Previous settings content] -->
                    
                    <div class="form-container mt-4">
                        <div class="form-header">
                            <h2><i class="fas fa-building"></i> Company Management</h2>
                        </div>
                        <div id="company-settings">
                            <!-- Dynamic content -->
                        </div>
                    </div>

                    <div class="form-container mt-4">
                        <div class="form-header">
                            <h2><i class="fas fa-file-alt"></i> Document Numbering</h2>
                            <div class="table-actions">
                                <button class="btn btn-outline" id="reset-counters-btn">
                                    <i class="fas fa-sync-alt"></i> Reset Counters
                                </button>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Financial Year Start Month</label>
                                <select id="fy-start-month" class="form-control">
                                    <!-- Months will be populated -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Current Document Number Preview</label>
                                <div class="prefix-preview" id="doc-preview">
                                    INV/202324/0001
                                </div>
                                <small class="text-muted">Tokens: 
                                    <span class="token-badge">[PREFIX]</span>
                                    <span class="token-badge">[FY]</span>
                                    <span class="token-badge">[FYFULL]</span>
                                    <span class="token-badge">[SEQ]</span>
                                    <span class="token-badge">[SEQ4]</span>
                                    <span class="token-badge">[SEQ5]</span>
                                </small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Custom Pattern</label>
                                <input type="text" id="custom-pattern" class="form-control" 
                                    value="[PREFIX]/[FY]/[SEQ4]">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Invoice Prefix</label>
                                <input type="text" id="invoice-prefix" class="form-control" value="INV">
                            </div>
                            <div class="form-group">
                                <label>Quotation Prefix</label>
                                <input type="text" id="quotation-prefix" class="form-control" value="QUT">
                            </div>
                            <div class="form-group">
                                <label>Challan Prefix</label>
                                <input type="text" id="challan-prefix" class="form-control" value="CHL">
                            </div>
                        </div>
                        <div class="form-footer">
                            <button class="btn btn-primary" id="save-numbering-btn">
                                <i class="fas fa-save"></i> Save Numbering Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- [Previous modal dialogs remain the same] -->

    <script>
        // Enhanced Application State
        const state = {
            currentUser: null,
            currentCompany: 'main',
            companies: {
                main: {
                    name: "Main Company",
                    settings: {
                        invoicePrefix: 'INV',
                        quotationPrefix: 'QUT',
                        challanPrefix: 'CHL',
                        defaultDueDays: 30,
                        fyStartMonth: 3, // April (0=Jan, 11=Dec)
                        customPattern: "[PREFIX]/[FY]/[SEQ4]"
                    },
                    lastDocNumbers: {
                        invoice: 3,
                        quotation: 2,
                        challan: 1
                    },
                    documents: []
                }
            },
            financialYear: "2023-24",
            financialYearShort: "2324"
        };

        // Document Types
        const DOCUMENT_TYPES = {
            invoice: {
                name: "Invoice",
                prefix: "invoicePrefix",
                icon: "file-invoice"
            },
            quotation: {
                name: "Quotation",
                prefix: "quotationPrefix",
                icon: "file-contract"
            },
            challan: {
                name: "Challan",
                prefix: "challanPrefix",
                icon: "truck-loading"
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const loginView = document.getElementById('login-view');
            const appContainer = document.getElementById('app-container');
            const menuToggle = document.querySelector('.menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const googleSignInBtn = document.getElementById('google-signin-btn');
            const companySelector = document.getElementById('company-selector');
            const financialYearDisplay = document.getElementById('financial-year-display');

            // Initialize the app
            initCompanySystem();
            detectFinancialYear();
            loadDemoData();
            initEventListeners();

            // Core Functions
            function initCompanySystem() {
                // Load from localStorage
                const savedData = localStorage.getItem('expensesFlowData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    state.companies = parsed.companies || state.companies;
                    state.currentCompany = parsed.currentCompany || state.currentCompany;
                }

                // Populate company selector
                companySelector.innerHTML = '';
                Object.entries(state.companies).forEach(([id, company]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = company.name;
                    option.selected = id === state.currentCompany;
                    companySelector.appendChild(option);
                });

                updateFinancialYearDisplay();
            }

            function detectFinancialYear() {
                const now = new Date();
                const company = state.companies[state.currentCompany];
                const fyStartMonth = company.settings.fyStartMonth;
                
                let startYear = now.getFullYear();
                if (now.getMonth() < fyStartMonth) {
                    startYear--;
                }
                
                state.financialYear = `${startYear}-${startYear + 1}`;
                state.financialYearShort = `${startYear.toString().slice(2)}${(startYear + 1).toString().slice(2)}`;
            }

            function generateDocumentNumber(type) {
                const company = state.companies[state.currentCompany];
                const settings = company.settings;
                const prefix = settings[DOCUMENT_TYPES[type].prefix];
                
                // Increment counter
                company.lastDocNumbers[type]++;
                
                // Generate number
                return settings.customPattern
                    .replace('[PREFIX]', prefix)
                    .replace('[FY]', state.financialYearShort)
                    .replace('[FYFULL]', state.financialYear)
                    .replace('[SEQ]', company.lastDocNumbers[type])
                    .replace('[SEQ4]', company.lastDocNumbers[type].toString().padStart(4, '0'))
                    .replace('[SEQ5]', company.lastDocNumbers[type].toString().padStart(5, '0'));
            }

            function updateFinancialYearDisplay() {
                financialYearDisplay.textContent = `FY: ${state.financialYear}`;
            }

            function saveToLocalStorage() {
                localStorage.setItem('expensesFlowData', JSON.stringify({
                    companies: state.companies,
                    currentCompany: state.currentCompany
                }));
            }

            function loadDemoData() {
                // Sample documents
                state.companies.main.documents = [
                    createDemoDocument('invoice', "Global Tech Solutions", 2530),
                    createDemoDocument('quotation', "Innovate Services Ltd", 3630),
                    createDemoDocument('challan', "Prime Logistics", 2550)
                ];
            }

            function createDemoDocument(type, client, amount) {
                const docType = DOCUMENT_TYPES[type];
                return {
                    id: generateDocumentNumber(type),
                    type: docType.name,
                    date: new Date().toISOString().split('T')[0],
                    client: client,
                    amount: amount,
                    status: type === 'invoice' ? 'Paid' : type === 'quotation' ? 'Pending' : 'Delivered',
                    createdAt: new Date().toISOString()
                };
            }

            function initEventListeners() {
                // Company selector
                companySelector.addEventListener('change', function() {
                    state.currentCompany = this.value;
                    detectFinancialYear();
                    updateFinancialYearDisplay();
                    saveToLocalStorage();
                });

                // Token badges
                document.querySelectorAll('.token-badge').forEach(badge => {
                    badge.addEventListener('click', function() {
                        const patternInput = document.getElementById('custom-pattern');
                        patternInput.value += this.textContent;
                        patternInput.focus();
                        updatePatternPreview();
                    });
                });

                // Numbering settings
                document.getElementById('save-numbering-btn').addEventListener('click', saveNumberingSettings);
                document.getElementById('reset-counters-btn').addEventListener('click', resetDocumentCounters);

                // Pattern inputs
                document.getElementById('custom-pattern').addEventListener('input', updatePatternPreview);
                document.getElementById('fy-start-month').addEventListener('change', updateFinancialYearSettings);
                document.getElementById('invoice-prefix').addEventListener('input', updatePatternPreview);
                document.getElementById('quotation-prefix').addEventListener('input', updatePatternPreview);
                document.getElementById('challan-prefix').addEventListener('input', updatePatternPreview);
            }

            function updatePatternPreview() {
                const company = state.companies[state.currentCompany];
                const pattern = document.getElementById('custom-pattern').value || company.settings.customPattern;
                const invoicePrefix = document.getElementById('invoice-prefix').value || company.settings.invoicePrefix;
                
                document.getElementById('doc-preview').textContent = pattern
                    .replace('[PREFIX]', invoicePrefix)
                    .replace('[FY]', state.financialYearShort)
                    .replace('[FYFULL]', state.financialYear)
                    .replace('[SEQ]', '1')
                    .replace('[SEQ4]', '0001')
                    .replace('[SEQ5]', '00001');
            }

            function saveNumberingSettings() {
                const company = state.companies[state.currentCompany];
                company.settings = {
                    invoicePrefix: document.getElementById('invoice-prefix').value,
                    quotationPrefix: document.getElementById('quotation-prefix').value,
                    challanPrefix: document.getElementById('challan-prefix').value,
                    defaultDueDays: company.settings.defaultDueDays,
                    fyStartMonth: company.settings.fyStartMonth,
                    customPattern: document.getElementById('custom-pattern').value
                };
                
                saveToLocalStorage();
                alert("Numbering settings saved successfully!");
            }

            function resetDocumentCounters() {
                if (confirm("Reset all document counters to 0 for current company?")) {
                    const company = state.companies[state.currentCompany];
                    company.lastDocNumbers = { invoice: 0, quotation: 0, challan: 0 };
                    saveToLocalStorage();
                    alert("Document counters reset!");
                }
            }

            function updateFinancialYearSettings() {
                const company = state.companies[state.currentCompany];
                company.settings.fyStartMonth = parseInt(document.getElementById('fy-start-month').value);
                detectFinancialYear();
                updateFinancialYearDisplay();
                updatePatternPreview();
                saveToLocalStorage();
            }

            // Initialize month selector
            function initMonthSelector() {
                const selector = document.getElementById('fy-start-month');
                selector.innerHTML = '';
                for (let i = 0; i < 12; i++) {
                    const monthName = new Date(2000, i, 1).toLocaleString('default', { month: 'long' });
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = monthName;
                    option.selected = i === state.companies[state.currentCompany].settings.fyStartMonth;
                    selector.appendChild(option);
                }
            }

            // Initialize everything
            initMonthSelector();
            updatePatternPreview();

            // Simulate login for demo
            googleSignInBtn.addEventListener('click', function() {
                handleLoginSuccess({
                    name: "Admin User",
                    email: "admin@expensesflow.com",
                    avatar: "https://randomuser.me/api/portraits/men/1.jpg",
                    role: "admin",
                    isAdmin: true
                });
            });

            function handleLoginSuccess(user) {
                loginView.classList.add('hidden');
                appContainer.classList.remove('hidden');
                state.currentUser = user;
                document.getElementById('user-name').textContent = user.name;
                document.getElementById('user-avatar').src = user.avatar;
            }
        });
    </script>
</body>
</html>
